<!-- 
  Template de la liste des utilisateurs (Interface Admin)
  
  Affiche :
  - Statistiques globales
  - Barre de recherche
  - Liste des utilisateurs avec leurs informations
  - √âtats de chargement et d'erreur
-->

<div class="admin-container">
  
  <!-- ============================================================
       HEADER : TITRE + ACTIONS
       ============================================================ -->
  <div class="admin-header">
    <h1>Gestion des utilisateurs</h1>
  </div>

  <!-- ============================================================
       STATISTIQUES
       ============================================================ -->
  <div class="stats-grid">
    <div class="stat-card">
      <span class="stat-number">{{ totalUsers }}</span>
      <span class="stat-label">Total utilisateurs</span>
    </div>
    
    <div class="stat-card">
      <span class="stat-number">{{ totalAdmins }}</span>
      <span class="stat-label">Administrateurs</span>
    </div>
    
    <div class="stat-card">
      <span class="stat-number">{{ totalRegularUsers }}</span>
      <span class="stat-label">Utilisateurs standard</span>
    </div>
    
    <div class="stat-card">
      <span class="stat-number">{{ totalVerifiedUsers }}</span>
      <span class="stat-label">Emails v√©rifi√©s</span>
    </div>

    <div class="stat-card stat-danger">
      <span class="stat-number">{{ totalPendingDeletion }}</span>
      <span class="stat-label">En attente de suppression</span>
    </div>
  </div>

  <!-- ============================================================
       BARRE DE RECHERCHE ET FILTRES
       ============================================================ -->
  <div class="search-and-filters">
    <div class="search-bar">
      <input 
        type="text"
        class="search-input"
        placeholder="Rechercher par email, pr√©nom ou nom..."
        [(ngModel)]="searchTerm"
        (input)="onSearch()"
        [disabled]="loading"
      />
      
      <button 
        class="btn-clear-search" 
        (click)="clearSearch()"
        *ngIf="searchTerm"
        title="R√©initialiser la recherche">
        ‚úï
      </button>
    </div>

    <div class="filter-buttons">
      <button 
        class="filter-btn"
        [class.active]="selectedFilter === 'all'"
        (click)="changeFilter('all')">
        Tous
      </button>
      <button 
        class="filter-btn"
        [class.active]="selectedFilter === 'active'"
        (click)="changeFilter('active')">
        Actifs
      </button>
      <button 
        class="filter-btn filter-danger"
        [class.active]="selectedFilter === 'deleted'"
        (click)="changeFilter('deleted')">
        En attente de suppression
      </button>
    </div>
  </div>

  <!-- ============================================================
       √âTAT DE CHARGEMENT
       ============================================================ -->
  <div class="loading-container" *ngIf="loading">
    <div class="spinner"></div>
    <p>Chargement des utilisateurs...</p>
  </div>

  <!-- ============================================================
       MESSAGE D'ERREUR
       ============================================================ -->
  <div class="error-message" *ngIf="errorMessage && !loading">
    <span class="error-icon">‚ö†Ô∏è</span>
    <span>{{ errorMessage }}</span>
    <button class="btn-retry" (click)="loadUsers()">R√©essayer</button>
  </div>

  <!-- ============================================================
       LISTE DES UTILISATEURS
       ============================================================ -->
  <div class="users-list" *ngIf="!loading && !errorMessage">
    
    <!-- Message si aucun r√©sultat -->
    <div class="no-results" *ngIf="filteredUsers.length === 0">
      <p>Aucun utilisateur trouv√©</p>
      <button class="btn-clear-search" (click)="clearSearch()" *ngIf="searchTerm">
        R√©initialiser la recherche
      </button>
    </div>

    <!-- Tableau des utilisateurs -->
    <table class="users-table" *ngIf="filteredUsers.length > 0">
      <thead>
        <tr>
          <th>Email</th>
          <th>Nom complet</th>
          <th>R√¥le</th>
          <th>Action</th>
          <th>V√©rification</th>
          <th>RGPD</th>
          <th>Statut</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let user of filteredUsers; trackBy: trackByUserId" class="user-row">

          <!-- Email -->
          <td class="user-email">
            {{ user.email }}
            <span class="oauth-badge" *ngIf="user.googleId" title="Compte Google">
              üîó Google
            </span>
          </td>
          
          <!-- Nom complet -->
          <td class="user-name">
            <span *ngIf="user.firstName || user.lastName">
              {{ user.firstName }} {{ user.lastName }}
            </span>
            <span class="text-muted" *ngIf="!user.firstName && !user.lastName">
              Non renseign√©
            </span>
          </td>
          
          <!-- R√¥le -->
          <td>
            <span 
              class="badge"
              [class.badge-admin]="isAdmin(user)"
              [class.badge-user]="!isAdmin(user)">
              {{ getRoleBadge(user) }}
            </span>
          </td>

          <!-- Action r√¥le -->
          <td>
            <button
              class="btn-role"
              [class.btn-role--admin]="isAdmin(user)"
              [disabled]="isUpdatingRole(user)"
              (click)="toggleAdminRole(user)"
            >
              {{ isAdmin(user) ? 'Retirer admin' : 'Passer admin' }}
            </button>
          </td>
          
          <!-- V√©rification email -->
          <td>
            <span 
              class="badge"
              [class.badge-success]="user.isVerified"
              [class.badge-warning]="!user.isVerified">
              {{ getVerificationBadge(user) }}
            </span>
          </td>
          
          <!-- Consentement RGPD -->
          <td class="user-rgpd">
            <span *ngIf="user.consentRgpd" class="rgpd-ok" title="Consentement donn√©">
              ‚úÖ
            </span>
            <span *ngIf="!user.consentRgpd" class="rgpd-ko" title="Consentement non donn√©">
              ‚ùå
            </span>
            <span class="rgpd-date" *ngIf="user.consentRgpdAt">
              {{ user.consentRgpdAt | date:'dd/MM/yyyy' }}
            </span>
          </td>

          <!-- Statut de suppression -->
          <td class="user-status">
            <span 
              *ngIf="!isMarkedForDeletion(user)"
              class="badge badge-active">
              Actif
            </span>
            <button 
              *ngIf="isMarkedForDeletion(user)"
              class="btn-hard-delete"
              (click)="openDeleteModal(user)"
              title="Confirmer la suppression">
              Confirmer suppression
            </button>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Nombre de r√©sultats -->
    <div class="results-count" *ngIf="filteredUsers.length > 0">
      Affichage de {{ filteredUsers.length }} utilisateur(s)
      <span *ngIf="searchTerm"> correspondant √† "{{ searchTerm }}"</span>
    </div>
  </div>
</div>

<!-- Modal de confirmation pour hard delete -->
<app-confirm-modal
  [open]="showDeleteModal"
  [title]="'Confirmer la suppression d√©finitive ?'"
  [message]="'Vous √™tes sur le point de supprimer d√©finitivement le compte de ' + (userToDelete?.email || '') + '. Cette action est irr√©versible et toutes les donn√©es associ√©es seront supprim√©es.'"
  [confirmText]="'Oui, supprimer d√©finitivement'"
  [cancelText]="'Annuler'"
  [danger]="true"
  [loading]="deletingUser"
  (confirm)="confirmDeleteUser()"
  (cancel)="closeDeleteModal()">
</app-confirm-modal>