<div class="relances-container">

  <!-- HEADER STATS -->
  <ng-container *ngIf="stats$ | async as stats">
    <app-relances-header [stats]="stats"></app-relances-header>
  </ng-container>

  <!-- LISTE + ONGLET -->
  <ng-container *ngIf="candidatures$ | async as candidatures">

    <!-- ONGLET -->
    <div class="quick-filters">
      <button type="button" [class.active]="filterStatus === 'relances'" (click)="filterStatus = 'relances'">
        Mes relances
      </button>

      <button type="button" [class.active]="filterStatus === 'reponses'" (click)="filterStatus = 'reponses'">
        RÃ©ponses employeurs
      </button>
    </div>

    <!-- EMPTY -->
    <div *ngIf="candidatures.length === 0" class="empty-state">
      <p>Aucune candidature Ã  afficher</p>
    </div>

    <!-- LISTE -->
    <div class="candidatures-list" *ngIf="candidatures.length > 0">

      <div *ngFor="let c of candidatures" class="candidature-timeline-card">

        <!-- PROGRESSION -->
        <div class="progress-circle" aria-label="Progression des relances">
          <svg viewBox="0 0 36 36">
            <path class="circle-bg" d="M18 2.0845
                 a 15.9155 15.9155 0 0 1 0 31.831
                 a 15.9155 15.9155 0 0 1 0 -31.831" />
            <path class="circle-progress" [attr.stroke-dasharray]="helpers.getProgress(c) + ', 100'" d="M18 2.0845
                 a 15.9155 15.9155 0 0 1 0 31.831
                 a 15.9155 15.9155 0 0 1 0 -31.831" />
          </svg>

          <span class="progress-text">
            {{ helpers.getProgress(c) | number:'1.0-0' }}%
          </span>
        </div>

        <!-- INFOS CANDIDATURE -->
        <div class="card-header">
          <div class="card-info">
            <h3 class="job-title">{{ c.jobTitle }}</h3>

            <p class="company-name">
              {{ c.entreprise.nom || 'Entreprise inconnue' }}
            </p>

            <p class="candidature-meta">
              EnvoyÃ©e il y a {{ helpers.getDaysSince(c.dateCandidature) }} jours
              <span class="date-badge">
                {{ c.dateCandidature | date:'dd/MM/yyyy' }}
              </span>
            </p>
          </div>
        </div>

        <!-- ONGLET : RELANCES -->
        <ng-container *ngIf="filterStatus === 'relances'; else reponsesBlock">

          <div class="relances-timeline">
            <ng-container *ngFor="let rang of [1, 2, 3]">
              <ng-container *ngIf="helpers.getRelanceByRang(c, rang) as r">

                <div class="timeline-item" [class.done]="r.faite"
                  [class.overdue]="helpers.isRelanceOverdue(r) && !r.faite"
                  [class.upcoming]="!r.faite && !helpers.isRelanceOverdue(r)">
                  <div class="timeline-point" [class.done]="r.faite"
                    [class.overdue]="helpers.isRelanceOverdue(r) && !r.faite"
                    [class.upcoming]="!r.faite && !helpers.isRelanceOverdue(r)"></div>

                  <div class="timeline-content">
                    <div class="timeline-header">
                      <span class="relance-number">Relance {{ rang }}</span>
                      <span class="relance-timing">
                        +{{ rang }} semaine{{ rang > 1 ? 's' : '' }}
                      </span>
                    </div>

                    <div class="relance-date">
                      {{ r.dateRelance | date:'dd/MM' }}
                      <span *ngIf="helpers.isRelanceOverdue(r) && !r.faite" class="overdue-badge">
                        !
                      </span>
                    </div>

                    <div class="relance-actions">
                      <button type="button" *ngIf="!r.faite" class="btn-mark-done"
                        [class.btn-urgent]="helpers.isRelanceOverdue(r)" (click)="markDone(r)">
                        âœ“ Marquer comme faite
                      </button>

                      <div *ngIf="r.faite" class="status-done">
                        âœ“
                        <button type="button" class="btn-mark-done btn-urgent" (click)="markUndone(r)"
                          aria-label="Annuler la relance">
                          âœ•
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

              </ng-container>
            </ng-container>
          </div>
        </ng-container>

        <!-- ONGLET : RÃ‰PONSES -->
        <ng-template #reponsesBlock>

          <div class="reponses-wrapper">
            <div class="reponses-timeline">

              <button type="button" class="reponse-item reponse-item--attente"
                [class.active]="c.statutReponse === 'attente'" (click)="updateStatut(c, 'attente')">
                <div class="reponse-point reponse-point--neutral"></div>
                <div class="reponse-label">Attente</div>
              </button>

              <button type="button" class="reponse-item reponse-item--echanges"
                [class.active]="c.statutReponse === 'echanges'" (click)="updateStatut(c, 'echanges')">
                <div class="reponse-point reponse-point--info"></div>
                <div class="reponse-label">Ã‰changes</div>
              </button>

              <button type="button" class="reponse-item reponse-item--negative"
                [class.active]="c.statutReponse === 'negative'" (click)="updateStatut(c, 'negative')">
                <div class="reponse-point reponse-point--danger"></div>
                <div class="reponse-label">Refus</div>
              </button>

              <button type="button" class="reponse-item reponse-item--entretien"
                [class.active]="helpers.hasEntretienPrevu(c)" (click)="openEntretien(c)">
                <div class="reponse-point reponse-point--success"></div>
                <div class="reponse-label">
                  {{ helpers.getNbEntretiensPrevus(c) || '+' }} Entretien
                </div>
              </button>

              <button type="button" class="reponse-item reponse-item--engage"
                [class.active]="c.statutReponse === 'engage'" (click)="updateStatut(c, 'engage')">
                <div class="reponse-point reponse-point--engage"></div>
                <div class="reponse-label">EngagÃ©</div>
              </button>

            </div>

            <!-- ENTRETIENS -->
<div
  *ngIf="helpers.hasEntretienPrevu(c)"
  class="entretiens-preview-row"
>
  <ng-container *ngFor="let e of c.entretiens">
    <div
      *ngIf="e.statut === 'prevu'"
      class="entretien-preview-pill"
    >
      ðŸ“… {{ helpers.formatDate(e.dateEntretien) }}
      <span *ngIf="e.heureEntretien">
        Ã  {{ helpers.formatHeure(e.heureEntretien) }}
      </span>
      
      <button
        type="button"
        class="pill-delete-btn"
        (click)="deleteEntretien(c, e, $event)"
        aria-label="Supprimer l'entretien"
      >
        âœ•
      </button>
    </div>
  </ng-container>
</div>

          </div>
        </ng-template>

      </div>
    </div>
  </ng-container>
</div>

<!-- MODALE ENTRETIEN -->
<app-entretien-modal [show]="showEntretienModal" [entrepriseNom]="selectedCandidature?.entreprise?.nom || ''"
  [jobTitle]="selectedCandidature?.jobTitle || ''" [formData]="entretienForm" (close)="closeEntretien()"
  (submit)="submitEntretien($event)"></app-entretien-modal>