<!-- relances.component.html -->
<div class="relances-container">
  <!-- Header avec stats -->
  <div class="relances-header">
    <h1>Mes relances</h1>
    <div class="stats-bar">
      <div class="stat-item">
        <span class="stat-number">{{ candidatures.length }}</span>
        <span class="stat-label">Candidatures</span>
      </div>
      <div class="stat-item urgent">
        <span class="stat-number">{{ getPendingCount() }}</span>
        <span class="stat-label">Ã€ relancer</span>
      </div>
      <div class="stat-item done">
        <span class="stat-number">{{ getDoneRelancesCount() }}</span>
        <span class="stat-label">Relances effectuÃ©es</span>
      </div>
    </div>
  </div>

  <!-- Filtres rapides -->
  <div class="quick-filters">
    <button [class.active]="filterStatus === 'relances'" (click)="filterStatus = 'relances'">
      Mes relances
    </button>
    <button [class.active]="filterStatus === 'reponses'" (click)="filterStatus = 'reponses'">
      RÃ©ponses employeurs
    </button>
  </div>

  <!-- Liste des candidatures -->
  <div class="candidatures-list">
    <div *ngFor="let c of filteredCandidatures" class="candidature-timeline-card">

      <!-- Cercle de progression -->
      <div class="progress-circle">
        <svg viewBox="0 0 36 36">
          <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
          <path class="circle-progress" [attr.stroke-dasharray]="getProgress(c) + ', 100'"
            d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
        </svg>
        <span class="progress-text">{{ getProgress(c) | number:'1.0-0' }}%</span>
      </div>

      <!-- Informations de la candidature -->
      <div class="card-header">
        <div class="card-info">
          <h3 class="job-title">{{ c.jobTitle }}</h3>
          <p class="company-name">{{ c.entreprise.nom || 'Entreprise inconnue' }}</p>
          <p class="candidature-meta">
            Candidature envoyÃ©e il y a {{ getDaysSince(c.dateCandidature) }} jours
            <span class="date-badge">{{ c.dateCandidature | date:'dd/MM/yyyy' }}</span>
          </p>
        </div>
      </div>

      <!-- Affichage conditionnel selon l'onglet -->
      <ng-container *ngIf="filterStatus === 'relances'; else etatCandidatureBlock">
        <!-- ============================================ -->
        <!-- ONGLET "MES RELANCES" (INCHANGÃ‰)            -->
        <!-- ============================================ -->
        <div class="relances-timeline">
          <ng-container *ngFor="let rang of [1, 2, 3]">
            <ng-container *ngIf="getRelanceByRang(c, rang) as r">
              <div class="timeline-item" [class.done]="r.faite" [class.overdue]="isRelanceOverdue(r) && !r.faite"
                [class.upcoming]="!r.faite && !isRelanceOverdue(r)" [class.clickable]="!r.faite"
                (click)="!r.faite ? markAsDone(c, r) : null">
                <div class="timeline-point" [class.done]="r.faite" [class.overdue]="isRelanceOverdue(r) && !r.faite"
                  [class.upcoming]="!r.faite && !isRelanceOverdue(r)">
                </div>
                <div class="timeline-content">
                  <div class="timeline-header">
                    <span class="relance-number">Relance {{ rang }}</span>
                    <span class="relance-timing">+{{ rang }} semaine{{ rang > 1 ? 's' : '' }}</span>
                  </div>
                  <div class="relance-date">
                    {{ r.dateRelance | date:'dd/MM' }}
                    <span *ngIf="isRelanceOverdue(r) && !r.faite" class="overdue-badge">
                      !
                    </span>
                  </div>
                  <div class="relance-actions">
                    <button *ngIf="!r.faite" class="btn-mark-done" [class.btn-urgent]="isRelanceOverdue(r)"
                      (click)="$event.stopPropagation(); markAsDone(c, r)" title="Marquer comme faite">
                      âœ“ Marquer comme faite
                    </button>
                    <div *ngIf="r.faite" class="status-done">
                      <svg width="12" height="12" viewBox="0 0 16 16" fill="none">
                        <circle cx="8" cy="8" r="7" fill="#22c55e" />
                        <path d="M5 8L7 10L11 6" stroke="white" stroke-width="2" stroke-linecap="round"
                          stroke-linejoin="round" />
                      </svg>
                      <button (click)="$event.stopPropagation(); markAsUndone(c, r)" class="btn-mark-done btn-urgent"
                        title="Annuler">
                        âœ•
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </ng-container>
          </ng-container>
        </div>
      </ng-container>

      <!-- ============================================ -->
      <!-- ONGLET "RÃ‰PONSES EMPLOYEURS"                 -->
      <!-- Les entretiens sont maintenant SOUS          -->
      <!-- ============================================ -->
      <ng-template #etatCandidatureBlock>
        <!-- WRAPPER pour contenir timeline + entretiens verticalement -->
        <div class="reponses-wrapper">
          
          <!-- Timeline des statuts (horizontale) -->
          <div class="reponses-timeline">

            <!-- Cadre 1 : En attente -->
            <div class="reponse-item reponse-item--attente" [class.active]="c.statutReponse === 'attente'"
              [class.inactive]="c.statutReponse !== 'attente'" (click)="updateStatutReponse(c, 'attente', $event)">
              <div class="reponse-point reponse-point--neutral" [class.active]="c.statutReponse === 'attente'">
              </div>
              <div class="reponse-content">
                <div class="reponse-label">En attente</div>
                <div class="reponse-icon">â³</div>
              </div>
            </div>

            <!-- Cadre 2 : Ã‰changes en cours -->
            <div class="reponse-item reponse-item--echanges" [class.active]="c.statutReponse === 'echanges'"
              [class.inactive]="c.statutReponse !== 'echanges'" (click)="updateStatutReponse(c, 'echanges', $event)">
              <div class="reponse-point reponse-point--info" [class.active]="c.statutReponse === 'echanges'">
              </div>
              <div class="reponse-content">
                <div class="reponse-label">Ã‰changes</div>
                <div class="reponse-icon">ğŸ’¬</div>
              </div>
              <button *ngIf="c.statutReponse === 'echanges'" class="btn-reset-reponse"
                title="Annuler et repasser en attente" (click)="updateStatutReponse(c, 'echanges', $event)">âœ•</button>
            </div>

            <!-- Cadre 3 : Refus -->
            <div class="reponse-item reponse-item--negative" [class.active]="c.statutReponse === 'negative'"
              [class.inactive]="c.statutReponse !== 'negative'" (click)="updateStatutReponse(c, 'negative', $event)">
              <div class="reponse-point reponse-point--danger" [class.active]="c.statutReponse === 'negative'">
              </div>
              <div class="reponse-content">
                <div class="reponse-label">Refus</div>
                <div class="reponse-icon">âœ–</div>
              </div>
              <button *ngIf="c.statutReponse === 'negative'" class="btn-reset-reponse"
                title="Annuler et repasser en attente" (click)="updateStatutReponse(c, 'negative', $event)">âœ•</button>
            </div>

            <!-- Cadre 4 : Entretien(s) - Affichage enrichi -->
            <div class="reponse-item reponse-item--entretien" [class.active]="c.entretiens?.length"
              [class.inactive]="!c.entretiens?.length" (click)="openEntretienModal(c); $event.stopPropagation()">
              <div class="reponse-point reponse-point--success" [class.active]="c.entretiens?.length">
              </div>
              <div class="reponse-content">
                <div class="reponse-label">
                  <span *ngIf="!c.entretiens?.length" class="reponse-label-text">+ Entretien</span>
                  <span *ngIf="getNbEntretiensPrevus(c) > 0" class="reponse-label-text">
                    {{ getNbEntretiensPrevus(c) }} PrÃ©vus
                  </span>
                </div>
                <div class="reponse-icon">
                  <span>ğŸ“…</span>
                </div>
              </div>
            </div>

            <!-- Cadre 5 : EngagÃ© -->
            <div class="reponse-item reponse-item--engage" [class.active]="c.statutReponse === 'engage' || c.statutReponse === 'positive'"
              [class.inactive]="c.statutReponse !== 'engage' && c.statutReponse !== 'positive'" (click)="updateStatutReponse(c, 'engage', $event)">
              <div class="reponse-point reponse-point--engage" [class.active]="c.statutReponse === 'engage' || c.statutReponse === 'positive'">
              </div>
              <div class="reponse-content">
                <div class="reponse-label">EngagÃ©</div>
                <div class="reponse-icon">ğŸ‰</div>
              </div>
              <button *ngIf="c.statutReponse === 'engage' || c.statutReponse === 'positive'" class="btn-reset-reponse"
                title="Annuler et repasser en attente" (click)="updateStatutReponse(c, 'engage', $event)">âœ•</button>
            </div>

          </div>

          <!-- âœ… ENTRETIENS AFFICHÃ‰S SOUS LES STATUTS -->
          <div *ngIf="hasEntretienPrevu(c)" class="entretiens-preview-row">
            <ng-container *ngFor="let e of c.entretiens">
              <div *ngIf="e.statut === 'prevu'" class="entretien-preview-pill pill-hover-delete" (mouseenter)="e._hover=true" (mouseleave)="e._hover=false">
                <span class="entretien-icon">ğŸ“…</span>
                <span>{{ formatDate(e.dateEntretien) }}</span>
                <span *ngIf="e.heureEntretien">Ã  {{ formatHeure(e.heureEntretien) }}</span>
                <button *ngIf="e._hover" class="pill-delete-btn" title="Supprimer cet entretien" (click)="deleteEntretien(c, e, $event)">âœ•</button>
              </div>
            </ng-container>
          </div>

        </div>

        <!-- MODALE AJOUT ENTRETIEN (style confirmation suppression) -->
        <div class="modal-overlay" *ngIf="showEntretienModal" (click)="closeEntretienModal()">
          <div class="modal-card" (click)="$event.stopPropagation()">
            <div class="modal-header">
              <div class="modal-icon">ğŸ“…</div>
              <h3 class="modal-title">Ajouter un entretien</h3>
            </div>
            <p class="modal-text">
              Planifie un entretien pour <strong>{{ (modalCandidature?.entreprise?.nom ?
                (modalCandidature?.entreprise?.nom + ' - ') : '') + (modalCandidature?.jobTitle || '') || 'cette
                entreprise' }}</strong>.<br>
              Indique la date et l'heure du rendez-vous.
            </p>
            <form class="entretien-form" (ngSubmit)="createEntretienFromModal()">
              <div class="modal-fields">
                <label>
                  Date :
                  <input type="date" [(ngModel)]="entretienForm.date" name="date" required />
                </label>
                <label>
                  Heure :
                  <input type="time" [(ngModel)]="entretienForm.heure" name="heure" required />
                </label>
              </div>
              <div class="modal-actions">
                <button class="btn-secondary" type="button" (click)="closeEntretienModal()">Annuler</button>
                <button type="submit" class="btn-create-entretien">âœ“ Ajouter</button>
              </div>
            </form>
          </div>
        </div>

        <!-- Mini-formulaire entretien (conditionnel, en dessous de la timeline) -->
        <div class="entretiens-inline" *ngIf="editingEntretienFor === c['@id']" (click)="$event.stopPropagation()">

          <!-- Bouton crÃ©ation si aucun entretien -->
          <div class="entretien-form" *ngIf="!c.entretiens?.length">
            <button type="button" class="btn-create-entretien" (click)="createEntretien(c); $event.stopPropagation()">
              âœ“ CrÃ©er un entretien
            </button>
            <button type="button" class="btn-cancel-entretien"
              (click)="cancelEditEntretien(); $event.stopPropagation()">
              âœ• Annuler
            </button>
          </div>

          <!-- Liste des entretiens existants -->
          <div *ngFor="let e of c.entretiens; let i = index" class="entretien-item">

            <div class="entretien-header">
              <span class="entretien-numero">Entretien {{ i + 1 }}</span>
              <button type="button" class="btn-delete-entretien" (click)="deleteEntretien(c, e, $event)"
                title="Supprimer cet entretien">
                ğŸ—‘ï¸
              </button>
            </div>

            <!-- Entretien prÃ©vu -->
            <ng-container *ngIf="e.statut === 'prevu'">
              <div class="entretien-fields">
                <label class="entretien-field" (click)="$event.stopPropagation()">
                  <span class="field-label">Date :</span>
                  <input type="date" [(ngModel)]="e.dateEntretien" (change)="updateEntretien(e)"
                    (click)="$event.stopPropagation()" class="field-input" />
                </label>

                <label class="entretien-field" (click)="$event.stopPropagation()">
                  <span class="field-label">Heure :</span>
                  <input type="time" [(ngModel)]="e.heureEntretien" (change)="updateEntretien(e)"
                    (click)="$event.stopPropagation()" class="field-input" />
                </label>
              </div>

              <div class="entretien-actions">
                <button type="button" class="btn-entretien-result btn-entretien-result--success"
                  (click)="markEntretienAsPassed(e, 'positive'); $event.stopPropagation()">
                  âœ” RÃ©ussi
                </button>

                <button type="button" class="btn-entretien-result btn-entretien-result--danger"
                  (click)="markEntretienAsPassed(e, 'negative'); $event.stopPropagation()">
                  âœ– RefusÃ©
                </button>
              </div>
            </ng-container>

            <!-- Entretien passÃ© (affichage uniquement) -->
            <ng-container *ngIf="e.statut === 'passe'">
              <div class="entretien-result">
                <span class="entretien-badge entretien-badge--success" *ngIf="e.resultat === 'positive'">
                  âœ” RÃ©ussi le {{ formatDate(e.dateEntretien) }} Ã  {{ e.heureEntretien }}
                </span>

                <span class="entretien-badge entretien-badge--danger" *ngIf="e.resultat === 'negative'">
                  âœ– RefusÃ© le {{ formatDate(e.dateEntretien) }} Ã  {{ e.heureEntretien }}
                </span>
              </div>
            </ng-container>
          </div>

          <!-- Bouton ajouter un autre entretien -->
          <button type="button" *ngIf="c.entretiens?.length" class="btn-add-another-entretien"
            (click)="createEntretien(c); $event.stopPropagation()">
            + Ajouter un autre entretien
          </button>

          <!-- Bouton fermer -->
          <button type="button" class="btn-close-entretien" (click)="cancelEditEntretien(); $event.stopPropagation()">
            Fermer
          </button>
        </div>

      </ng-template>

    </div>

    <!-- Message si vide -->
    <div *ngIf="filteredCandidatures.length === 0" class="empty-state">
      <svg width="64" height="64" viewBox="0 0 64 64" fill="none">
        <circle cx="32" cy="32" r="30" stroke="#e5e7eb" stroke-width="4" />
        <path d="M32 20v16m0 4h.01" stroke="#9ca3af" stroke-width="4" stroke-linecap="round" />
      </svg>
      <p>Aucune candidature Ã  afficher</p>
    </div>
  </div>
</div>