name: CI - Continuous Integration

# DÃ©clenchement automatique sur push et pull request
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # Job 1 : Tests et qualitÃ© de code
  test:
    name: Tests unitaires et qualitÃ©
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: ğŸ“¦ Install dependencies
        run: npm ci
      
      - name: ğŸ§ª Run unit tests
        run: npm test
      
      - name: ğŸ“Š Upload coverage reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: coverage/
          retention-days: 7
  
  # Job 2 : Build de validation
  build:
    name: Build pour validation
    runs-on: ubuntu-latest
    needs: test
    
    strategy:
      matrix:
        environment: [sit, uat, production]
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: ğŸ“¦ Install dependencies
        run: npm ci
      
      - name: ğŸ”¨ Build ${{ matrix.environment }}
        run: npm run build -- --configuration=${{ matrix.environment }}
      
      - name: ğŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.environment }}-${{ github.sha }}
          path: dist/followup-front/browser
          retention-days: 7
      
      - name: ğŸ“ Check bundle size
        run: |
          echo "ğŸ“Š Taille du build ${{ matrix.environment }}:"
          du -sh dist/followup-front/browser
          echo "ğŸ“¦ DÃ©tail des fichiers:"
          ls -lh dist/followup-front/browser