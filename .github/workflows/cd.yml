name: CD - Continuous Deployment

# DÃ©clenchement manuel ou automatique aprÃ¨s merge sur main
on:
  # DÃ©clenchement manuel avec choix de l'environnement
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environnement cible'
        required: true
        type: choice
        options:
          - production
          - uat
          - sit
  
  # DÃ©clenchement automatique sur push vers main (production uniquement)
  push:
    branches:
      - main

jobs:
  # Job 1 : Build de production
  build-production:
    name: Build Production
    runs-on: ubuntu-latest
    # N'exÃ©cuter que si c'est un push sur main OU un workflow_dispatch vers production
    if: github.event_name == 'push' || github.event.inputs.environment == 'production'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: ğŸ“¦ Install dependencies
        run: npm ci
      
      - name: ğŸ”¨ Build Production
        run: npm run build -- --configuration=production
      
      - name: ğŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: production-build
          path: dist/followup-front/browser
          retention-days: 30
      
      - name: ğŸ“Š Build Summary
        run: |
          echo "âœ… Build Production terminÃ©"
          echo "ğŸ“ Taille: $(du -sh dist/followup-front/browser | cut -f1)"
          echo "ğŸ“¦ Fichiers: $(find dist/followup-front/browser -type f | wc -l) fichiers"
  
  # Job 2 : DÃ©ploiement sur Render
  deploy-render:
    name: DÃ©ployer sur Render
    needs: build-production
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: production-build
          path: dist/followup-front/browser
      
      - name: ğŸš€ Trigger Render deployment
        env:
          RENDER_DEPLOY_HOOK: ${{ secrets.RENDER_DEPLOY_HOOK }}
        run: |
          if [ -z "$RENDER_DEPLOY_HOOK" ]; then
            echo "âš ï¸  RENDER_DEPLOY_HOOK non configurÃ©"
            echo "â„¹ï¸  Le dÃ©ploiement se fera automatiquement via Render aprÃ¨s le push"
          else
            echo "ğŸš€ DÃ©clenchement du dÃ©ploiement Render..."
            curl -X POST "$RENDER_DEPLOY_HOOK"
            echo "âœ… DÃ©ploiement dÃ©clenchÃ© avec succÃ¨s"
          fi
      
      - name: ğŸ“‹ Post-deployment checklist
        run: |
          echo "ğŸ“ Checklist post-dÃ©ploiement:"
          echo "  â˜‘ï¸  Build uploadÃ©"
          echo "  â˜‘ï¸  Render notifiÃ©"
          echo "  â³ Attendre 2-3 minutes pour que Render dÃ©ploie"
          echo "  ğŸ” VÃ©rifier: https://followup-frontend.onrender.com"
  
  # Job 3 : Simulation SIT/UAT (pour la documentation)
  simulate-sit-uat:
    name: Simulation ${{ github.event.inputs.environment }}
    runs-on: ubuntu-latest
    if: github.event.inputs.environment == 'sit' || github.event.inputs.environment == 'uat'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: ğŸ“¦ Install dependencies
        run: npm ci
      
      - name: ğŸ”¨ Build ${{ github.event.inputs.environment }}
        run: npm run build -- --configuration=${{ github.event.inputs.environment }}
      
      - name: ğŸ“¤ Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.inputs.environment }}-build
          path: dist/followup-front/browser
          retention-days: 7
      
      - name: â„¹ï¸  Information dÃ©ploiement
        run: |
          echo "â„¹ï¸  Environnement ${{ github.event.inputs.environment }}"
          echo "ğŸ“ Dans un contexte rÃ©el d'entreprise, ce build serait dÃ©ployÃ© sur:"
          echo "    - SIT: Serveur de tests d'intÃ©gration"
          echo "    - UAT: Serveur de validation client"
          echo ""
          echo "ğŸ“ Pour le projet CDA, ces environnements sont documentÃ©s"
          echo "   mais seul PROD est dÃ©ployÃ© sur Render (plan gratuit)"